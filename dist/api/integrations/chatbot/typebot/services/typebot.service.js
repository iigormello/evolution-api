var Ee=Object.create;var H=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var re=(t,e)=>{for(var E in e)H(t,E,{get:e[E],enumerable:!0})},Y=(t,e,E,c)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of se(e))!ne.call(t,n)&&n!==E&&H(t,n,{get:()=>e[n],enumerable:!(c=te(e,n))||c.enumerable});return t};var y=(t,e,E)=>(E=t!=null?Ee(oe(t)):{},Y(e||!t||!t.__esModule?H(E,"default",{value:t,enumerable:!0}):E,t)),Se=t=>Y(H({},"__esModule",{value:!0}),t);var _e={};re(_e,{TypebotService:()=>$});module.exports=Se(_e);var k=y(require("dayjs")),q=y(require("fs"));var W=require("class-validator"),Q=y(require("dotenv"));Q.default.config();var w=class{constructor(){this.loadEnv()}get(e){return this.env[e]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY||"evolution",EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||""},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true"},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,W.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,W.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome",VERSION:process.env?.CONFIG_SESSION_PHONE_VERSION||null},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"}}}},f=new w;var ae=JSON.parse(q.default.readFileSync("./package.json","utf8")),F=t=>(0,k.default)(t).toDate().toString().replace(/\sGMT.+/,""),v=(s=>(s.LOG="\x1B[32m",s.INFO="\x1B[34m",s.WARN="\x1B[33m",s.ERROR="\x1B[31m",s.DEBUG="\x1B[36m",s.VERBOSE="\x1B[37m",s.DARK="\x1B[30m",s))(v||{});var X=(s=>(s.LOG="\x1B[32m%s\x1B[0m",s.DARK="\x1B[30m%s\x1B[0m",s.INFO="\x1B[34m%s\x1B[0m",s.WARN="\x1B[33m%s\x1B[0m",s.ERROR="\x1B[31m%s\x1B[0m",s.DEBUG="\x1B[36m%s\x1B[0m",s.VERBOSE="\x1B[37m%s\x1B[0m",s))(X||{}),j=(s=>(s.LOG="LOG",s.WARN="WARN",s.INFO="INFO",s.DARK="DARK",s.ERROR="ERROR",s.DEBUG="DEBUG",s.VERBOSE="VERBOSE",s))(j||{}),J=(s=>(s.LOG="\x1B[42m",s.INFO="\x1B[44m",s.WARN="\x1B[43m",s.DARK="\x1B[40m",s.ERROR="\x1B[41m",s.DEBUG="\x1B[46m",s.VERBOSE="\x1B[47m",s))(J||{}),V=class{constructor(e="Logger"){this.configService=f;this.instance=null;this.context=e}setContext(e){this.context=e}setInstance(e){this.instance=e}console(e,E){let c=[];this.configService.get("LOG").LEVEL.forEach(R=>c.push(j[R]));let n=typeof e;c.includes(E)&&(f.get("LOG").COLOR?(console.log("\x1B[1m"+X[E],"[Evolution API]","\x1B[1m"+v[E],this.instance?`[${this.instance}]`:"","\x1B[1m"+v[E],`v${ae.version}`,"\x1B[1m"+v[E],process.pid.toString(),"\x1B[0m","\x1B[1m"+v[E],"-","\x1B[1m\x1B[37m",`${F(Date.now())}  `,"\x1B[0m",v[E]+J[E]+"\x1B[1m",`${E} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,v[E]+"\x1B[1m",`[${n}]\x1B[0m`,v[E],n!=="object"?e:"","\x1B[0m"),n==="object"&&console.log(e,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${F(Date.now())}  `,`${E} `,`[${this.context}]`,`[${n}]`,e))}log(e){this.console(e,"LOG")}info(e){this.console(e,"INFO")}warn(e){this.console(e,"WARN")}error(e){this.console(e,"ERROR")}verbose(e){this.console(e,"VERBOSE")}debug(e){this.console(e,"DEBUG")}dark(e){this.console(e,"DARK")}};var Te=t=>{let e;f.get("S3").ENABLE?e=t.message.mediaUrl:e=t.key.id;let E={conversation:t?.message?.conversation,extendedTextMessage:t?.message?.extendedTextMessage?.text,contactMessage:t?.message?.contactMessage?.displayName,locationMessage:t?.message?.locationMessage?.degreesLatitude,viewOnceMessageV2:t?.message?.viewOnceMessageV2?.message?.imageMessage?.url||t?.message?.viewOnceMessageV2?.message?.videoMessage?.url||t?.message?.viewOnceMessageV2?.message?.audioMessage?.url,listResponseMessage:t?.message?.listResponseMessage?.title,responseRowId:t?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,templateButtonReplyMessage:t?.message?.templateButtonReplyMessage?.selectedId||t?.message?.buttonsResponseMessage?.selectedButtonId,audioMessage:t?.message?.speechToText?t?.message?.speechToText:t?.message?.audioMessage?`audioMessage|${e}`:void 0,imageMessage:t?.message?.imageMessage?`imageMessage|${e}${t?.message?.imageMessage?.caption?`|${t?.message?.imageMessage?.caption}`:""}`:void 0,videoMessage:t?.message?.videoMessage?`videoMessage|${e}${t?.message?.videoMessage?.caption?`|${t?.message?.videoMessage?.caption}`:""}`:void 0,documentMessage:t?.message?.documentMessage?`documentMessage|${e}${t?.message?.documentMessage?.caption?`|${t?.message?.documentMessage?.caption}`:""}`:void 0,documentWithCaptionMessage:t?.message?.documentWithCaptionMessage?.message?.documentMessage?`documentWithCaptionMessage|${e}${t?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption?`|${t?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`:""}`:void 0,externalAdReplyBody:t?.contextInfo?.externalAdReply?.body?`externalAdReplyBody|${t.contextInfo.externalAdReply.body}`:void 0},c=Object.keys(E).find(n=>E[n]!==void 0)||"unknown";return{...E,messageType:c}},ie=t=>{let e=Object.keys(t).find(c=>c!=="externalAdReplyBody"&&t[c]!==void 0),E=e?t[e]:void 0;return t.externalAdReplyBody&&(E=E?`${E}
${t.externalAdReplyBody}`:t.externalAdReplyBody),E},z=t=>{let e=Te(t);return ie(e)};var Z=y(require("axios")),ee=y(require("fs")),Ae=JSON.parse(ee.default.readFileSync("./package.json","utf8")),b=async t=>{if(!(process.env.TELEMETRY_ENABLED===void 0||process.env.TELEMETRY_ENABLED==="true")||t==="/")return;let E={route:t,apiVersion:`${Ae.version}`,timestamp:new Date},c=process.env.TELEMETRY_URL&&process.env.TELEMETRY_URL!==""?process.env.TELEMETRY_URL:"https://log.evolution-api.com/telemetry";Z.default.post(c,E).then(()=>{}).catch(()=>{})};var G=y(require("axios")),$=class{constructor(e,E,c){this.waMonitor=e;this.configService=E;this.prismaRepository=c;this.logger=new V("TypebotService")}async createNewSession(e,E){if(E.remoteJid==="status@broadcast")return;let c=Math.floor(Math.random()*1e10).toString();try{let n=this.configService.get("TYPEBOT").API_VERSION,R,P;n==="latest"?(R=`${E.url}/api/v1/typebots/${E.typebot}/startChat`,P={prefilledVariables:{...E.prefilledVariables,remoteJid:E.remoteJid,pushName:E.pushName||E.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}):(R=`${E.url}/api/v1/sendMessage`,P={startParams:{publicId:E.typebot,prefilledVariables:{...E.prefilledVariables,remoteJid:E.remoteJid,pushName:E.pushName||E.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}});let s=await G.default.post(R,P),U=null;return s?.data?.sessionId&&(U=await this.prismaRepository.integrationSession.create({data:{remoteJid:E.remoteJid,pushName:E.pushName||"",sessionId:`${c}-${s.data.sessionId}`,status:"opened",parameters:{...E.prefilledVariables,remoteJid:E.remoteJid,pushName:E.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number},awaitUser:!1,botId:E.botId,instanceId:e.id,type:"typebot"}})),{...s.data,session:U}}catch(n){this.logger.error(n);return}}async sendWAMessage(e,E,c,n,R,P,s){B(this.waMonitor.waInstances[e.name],E,c,R,P,s,C,this.prismaRepository).catch(r=>{console.error("Erro ao processar mensagens:",r)});function U(r,i){if(!r)return null;for(let p of r)if(p.lastBubbleBlockId===i)return p.wait?.secondsToWaitFor;return null}function C(r){let i="";if(r.text&&(i+=r.text),r.children&&r.type!=="a")for(let l of r.children)i+=C(l);r.type==="p"&&r.type!=="inline-variable"&&(i=i.trim()+`
`),r.type==="inline-variable"&&(i=i.trim()),r.type==="ol"&&(i=`
`+i.split(`
`).map((l,h)=>l?`${h+1}. ${l}`:"").join(`
`)),r.type==="li"&&(i=i.split(`
`).map(l=>l?`  ${l}`:"").join(`
`));let p="";r.bold&&(p+="*"),r.italic&&(p+="_"),r.underline&&(p+="~");let u=`${p}${i}${p.split("").reverse().join("")}`;return r.url&&(u=r.children[0]?.text?`[${u}]
(${r.url})`:`${r.url}`),u}async function B(r,i,p,u,l,h,x,M){for(let a of u){if(a.type==="text"){let o="";for(let T of a.content.richText){for(let O of T.children)o+=x(O);o+=`
`}if(o=o.replace(/\*\*/g,"").replace(/__/,"").replace(/~~/,"").replace(/\n$/,""),o=o.replace(/\n$/,""),o.includes("[list]")){let T={number:n.split("@")[0],title:"",description:"",buttonText:"",footerText:"",sections:[]},O=o.match(/\[title\]([\s\S]*?)(?=\[description\])/),I=o.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),A=o.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),m=o.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);O&&(T.title=O[1].trim()),I&&(T.description=I[1].trim()),A&&(T.buttonText=A[1].trim()),m&&(T.footerText=m[1].trim());let D=o.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(D){let L=D.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);L&&L.forEach(d=>{let _=d.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),S=d.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),N={title:_,rows:S?.map(K=>({title:K.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:K.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:K.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};T.sections.push(N)})}await r.listMessage(T)}else if(o.includes("[buttons]")){let T={number:n.split("@")[0],thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},O=o.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),I=o.match(/\[title\]([\s\S]*?)(?=\[description\])/),A=o.match(/\[description\]([\s\S]*?)(?=\[footer\])/),m=o.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);I&&(T.title=I[1].trim()),O&&(T.thumbnailUrl=O[1].trim()),A&&(T.description=A[1].trim()),m&&(T.footer=m[1].trim());let D={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[L,d]of Object.entries(D)){let _;for(;(_=d.exec(o))!==null;){let S=_[1].trim(),N={type:L};switch(L){case"pix":N.currency=S.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),N.name=S.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),N.keyType=S.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),N.key=S.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":N.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.id=S.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":N.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.copyCode=S.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":N.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.phoneNumber=S.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":N.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),N.url=S.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(N).length>1&&T.buttons.push(N)}}await r.buttonMessage(T)}else await r.textMessage({number:n.split("@")[0],delay:p?.delayMessage||1e3,text:o},!1);b("/message/sendText")}a.type==="image"&&(await r.mediaMessage({number:n.split("@")[0],delay:p?.delayMessage||1e3,mediatype:"image",media:a.content.url},null,!1),b("/message/sendMedia")),a.type==="video"&&(await r.mediaMessage({number:n.split("@")[0],delay:p?.delayMessage||1e3,mediatype:"video",media:a.content.url},null,!1),b("/message/sendMedia")),a.type==="audio"&&(await r.audioWhatsapp({number:n.split("@")[0],delay:p?.delayMessage||1e3,encoding:!0,audio:a.content.url},!1),b("/message/sendWhatsAppAudio"));let g=U(h,a.id);g&&await new Promise(o=>setTimeout(o,g*1e3))}if(console.log("input",l),l){if(l.type==="choice input"){let a="",g=l.items;for(let o of g)a+=`\u25B6\uFE0F ${o.content}
`;if(a=a.replace(/\n$/,""),a.includes("[list]")){let o={number:n.split("@")[0],title:"",description:"",buttonText:"",footerText:"",sections:[]},T=a.match(/\[title\]([\s\S]*?)(?=\[description\])/),O=a.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),I=a.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),A=a.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);T&&(o.title=T[1].trim()),O&&(o.description=O[1].trim()),I&&(o.buttonText=I[1].trim()),A&&(o.footerText=A[1].trim());let m=a.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(m){let D=m.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);D&&D.forEach(L=>{let d=L.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),_=L.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),S={title:d,rows:_?.map(N=>({title:N.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:N.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:N.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};o.sections.push(S)})}await r.listMessage(o)}else if(a.includes("[buttons]")){let o={number:n.split("@")[0],thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},T=a.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),O=a.match(/\[title\]([\s\S]*?)(?=\[description\])/),I=a.match(/\[description\]([\s\S]*?)(?=\[footer\])/),A=a.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);O&&(o.title=O[1].trim()),T&&(o.thumbnailUrl=T[1].trim()),I&&(o.description=I[1].trim()),A&&(o.footer=A[1].trim());let m={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[D,L]of Object.entries(m)){let d;for(;(d=L.exec(a))!==null;){let _=d[1].trim(),S={type:D};switch(D){case"pix":S.currency=_.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),S.name=_.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),S.keyType=_.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),S.key=_.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.id=_.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.copyCode=_.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.phoneNumber=_.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.url=_.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(S).length>1&&o.buttons.push(S)}}await r.buttonMessage(o)}else await r.textMessage({number:n.split("@")[0],delay:p?.delayMessage||1e3,text:a},!1);b("/message/sendText")}await M.integrationSession.update({where:{id:i.id},data:{awaitUser:!0}})}else p?.keepOpen?await M.integrationSession.update({where:{id:i.id},data:{status:"closed"}}):await M.integrationSession.deleteMany({where:{id:i.id}})}}async processTypebot(e,E,c,n,R,P,s,U,C,B,r,i,p,u,l,h){if(n&&s&&s>0){let o=Date.now(),T=new Date(n.updatedAt).getTime(),O=o-T;if(Math.floor(O/1e3/60)>s){u?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});let A=await this.createNewSession(e,{enabled:R?.enabled,url:P,typebot:U,expire:s,keywordFinish:C,delayMessage:B,unknownMessage:r,listeningFromMe:i,remoteJid:E,pushName:c.pushName,botId:R.id,prefilledVariables:h});if(A.session&&(n=A.session),A.messages.length===0){let m=z(c.message);if(!m){r&&(this.waMonitor.waInstances[e.name].textMessage({number:E.split("@")[0],delay:B||1e3,text:r},!1),b("/message/sendText"));return}if(C&&m.toLowerCase()===C.toLowerCase()){u?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});return}try{let D=this.configService.get("TYPEBOT").API_VERSION,L,d;D==="latest"?(L=`${P}/api/v1/sessions/${A.sessionId}/continueChat`,d={message:m}):(L=`${P}/api/v1/sendMessage`,d={message:m,sessionId:A.sessionId});let _=await G.default.post(L,d);await this.sendWAMessage(e,n,{expire:s,keywordFinish:C,delayMessage:B,unknownMessage:r,listeningFromMe:i,stopBotFromMe:p,keepOpen:u},E,_.data.messages,_.data.input,_.data.clientSideActions)}catch(D){this.logger.error(D);return}}await this.sendWAMessage(e,n,{expire:s,keywordFinish:C,delayMessage:B,unknownMessage:r,listeningFromMe:i,stopBotFromMe:p,keepOpen:u},E,A.messages,A.input,A.clientSideActions);return}}if(n&&n.status!=="opened")return;if(!n){let o=await this.createNewSession(e,{enabled:R?.enabled,url:P,typebot:U,expire:s,keywordFinish:C,delayMessage:B,unknownMessage:r,listeningFromMe:i,remoteJid:E,pushName:c?.pushName,botId:R.id,prefilledVariables:h});if(o?.session&&(n=o.session),await this.sendWAMessage(e,n,{expire:s,keywordFinish:C,delayMessage:B,unknownMessage:r,listeningFromMe:i,stopBotFromMe:p,keepOpen:u},E,o?.messages,o?.input,o?.clientSideActions),o.messages.length===0){if(!l){r&&(this.waMonitor.waInstances[e.name].textMessage({number:E.split("@")[0],delay:B||1e3,text:r},!1),b("/message/sendText"));return}if(C&&l.toLowerCase()===C.toLowerCase()){u?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});return}let T;try{let O=this.configService.get("TYPEBOT").API_VERSION,I,A;O==="latest"?(I=`${P}/api/v1/sessions/${o.sessionId}/continueChat`,A={message:l}):(I=`${P}/api/v1/sendMessage`,A={message:l,sessionId:o.sessionId}),T=await G.default.post(I,A),await this.sendWAMessage(e,n,{expire:s,keywordFinish:C,delayMessage:B,unknownMessage:r,listeningFromMe:i,stopBotFromMe:p,keepOpen:u},E,T.data.messages,T.data.input,T.data.clientSideActions)}catch(O){this.logger.error(O);return}}return}if(await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"opened",awaitUser:!1}}),!l){r&&(this.waMonitor.waInstances[e.name].textMessage({number:E.split("@")[0],delay:B||1e3,text:r},!1),b("/message/sendText"));return}if(C&&l.toLowerCase()===C.toLowerCase()){u?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});return}let x=this.configService.get("TYPEBOT").API_VERSION,M,a;x==="latest"?(M=`${P}/api/v1/sessions/${n.sessionId.split("-")[1]}/continueChat`,a={message:l}):(M=`${P}/api/v1/sendMessage`,a={message:l,sessionId:n.sessionId.split("-")[1]});let g=await G.default.post(M,a);await this.sendWAMessage(e,n,{expire:s,keywordFinish:C,delayMessage:B,unknownMessage:r,listeningFromMe:i,stopBotFromMe:p,keepOpen:u},E,g?.data?.messages,g?.data?.input,g?.data?.clientSideActions)}};0&&(module.exports={TypebotService});
//# sourceMappingURL=typebot.service.js.map