import q from"dayjs";import X from"fs";import{isBooleanString as K}from"class-validator";import k from"dotenv";k.config();var x=class{constructor(){this.loadEnv()}get(e){return this.env[e]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY||"evolution",EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||""},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true"},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:K(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:K(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome",VERSION:process.env?.CONFIG_SESSION_PHONE_VERSION||null},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"}}}},y=new x;var j=JSON.parse(X.readFileSync("./package.json","utf8")),W=o=>q(o).toDate().toString().replace(/\sGMT.+/,""),v=(t=>(t.LOG="\x1B[32m",t.INFO="\x1B[34m",t.WARN="\x1B[33m",t.ERROR="\x1B[31m",t.DEBUG="\x1B[36m",t.VERBOSE="\x1B[37m",t.DARK="\x1B[30m",t))(v||{});var w=(t=>(t.LOG="\x1B[32m%s\x1B[0m",t.DARK="\x1B[30m%s\x1B[0m",t.INFO="\x1B[34m%s\x1B[0m",t.WARN="\x1B[33m%s\x1B[0m",t.ERROR="\x1B[31m%s\x1B[0m",t.DEBUG="\x1B[36m%s\x1B[0m",t.VERBOSE="\x1B[37m%s\x1B[0m",t))(w||{}),$=(t=>(t.LOG="LOG",t.WARN="WARN",t.INFO="INFO",t.DARK="DARK",t.ERROR="ERROR",t.DEBUG="DEBUG",t.VERBOSE="VERBOSE",t))($||{}),Y=(t=>(t.LOG="\x1B[42m",t.INFO="\x1B[44m",t.WARN="\x1B[43m",t.DARK="\x1B[40m",t.ERROR="\x1B[41m",t.DEBUG="\x1B[46m",t.VERBOSE="\x1B[47m",t))(Y||{}),f=class{constructor(e="Logger"){this.configService=y;this.instance=null;this.context=e}setContext(e){this.context=e}setInstance(e){this.instance=e}console(e,E){let O=[];this.configService.get("LOG").LEVEL.forEach(R=>O.push($[R]));let r=typeof e;O.includes(E)&&(y.get("LOG").COLOR?(console.log("\x1B[1m"+w[E],"[Evolution API]","\x1B[1m"+v[E],this.instance?`[${this.instance}]`:"","\x1B[1m"+v[E],`v${j.version}`,"\x1B[1m"+v[E],process.pid.toString(),"\x1B[0m","\x1B[1m"+v[E],"-","\x1B[1m\x1B[37m",`${W(Date.now())}  `,"\x1B[0m",v[E]+Y[E]+"\x1B[1m",`${E} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,v[E]+"\x1B[1m",`[${r}]\x1B[0m`,v[E],r!=="object"?e:"","\x1B[0m"),r==="object"&&console.log(e,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${W(Date.now())}  `,`${E} `,`[${this.context}]`,`[${r}]`,e))}log(e){this.console(e,"LOG")}info(e){this.console(e,"INFO")}warn(e){this.console(e,"WARN")}error(e){this.console(e,"ERROR")}verbose(e){this.console(e,"VERBOSE")}debug(e){this.console(e,"DEBUG")}dark(e){this.console(e,"DARK")}};var J=o=>{let e;y.get("S3").ENABLE?e=o.message.mediaUrl:e=o.key.id;let E={conversation:o?.message?.conversation,extendedTextMessage:o?.message?.extendedTextMessage?.text,contactMessage:o?.message?.contactMessage?.displayName,locationMessage:o?.message?.locationMessage?.degreesLatitude,viewOnceMessageV2:o?.message?.viewOnceMessageV2?.message?.imageMessage?.url||o?.message?.viewOnceMessageV2?.message?.videoMessage?.url||o?.message?.viewOnceMessageV2?.message?.audioMessage?.url,listResponseMessage:o?.message?.listResponseMessage?.title,responseRowId:o?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,templateButtonReplyMessage:o?.message?.templateButtonReplyMessage?.selectedId||o?.message?.buttonsResponseMessage?.selectedButtonId,audioMessage:o?.message?.speechToText?o?.message?.speechToText:o?.message?.audioMessage?`audioMessage|${e}`:void 0,imageMessage:o?.message?.imageMessage?`imageMessage|${e}${o?.message?.imageMessage?.caption?`|${o?.message?.imageMessage?.caption}`:""}`:void 0,videoMessage:o?.message?.videoMessage?`videoMessage|${e}${o?.message?.videoMessage?.caption?`|${o?.message?.videoMessage?.caption}`:""}`:void 0,documentMessage:o?.message?.documentMessage?`documentMessage|${e}${o?.message?.documentMessage?.caption?`|${o?.message?.documentMessage?.caption}`:""}`:void 0,documentWithCaptionMessage:o?.message?.documentWithCaptionMessage?.message?.documentMessage?`documentWithCaptionMessage|${e}${o?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption?`|${o?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`:""}`:void 0,externalAdReplyBody:o?.contextInfo?.externalAdReply?.body?`externalAdReplyBody|${o.contextInfo.externalAdReply.body}`:void 0},O=Object.keys(E).find(r=>E[r]!==void 0)||"unknown";return{...E,messageType:O}},z=o=>{let e=Object.keys(o).find(O=>O!=="externalAdReplyBody"&&o[O]!==void 0),E=e?o[e]:void 0;return o.externalAdReplyBody&&(E=E?`${E}
${o.externalAdReplyBody}`:o.externalAdReplyBody),E},Q=o=>{let e=J(o);return z(e)};import Z from"axios";import ee from"fs";var Ee=JSON.parse(ee.readFileSync("./package.json","utf8")),b=async o=>{if(!(process.env.TELEMETRY_ENABLED===void 0||process.env.TELEMETRY_ENABLED==="true")||o==="/")return;let E={route:o,apiVersion:`${Ee.version}`,timestamp:new Date},O=process.env.TELEMETRY_URL&&process.env.TELEMETRY_URL!==""?process.env.TELEMETRY_URL:"https://log.evolution-api.com/telemetry";Z.post(O,E).then(()=>{}).catch(()=>{})};import G from"axios";var F=class{constructor(e,E,O){this.waMonitor=e;this.configService=E;this.prismaRepository=O;this.logger=new f("TypebotService")}async createNewSession(e,E){if(E.remoteJid==="status@broadcast")return;let O=Math.floor(Math.random()*1e10).toString();try{let r=this.configService.get("TYPEBOT").API_VERSION,R,P;r==="latest"?(R=`${E.url}/api/v1/typebots/${E.typebot}/startChat`,P={prefilledVariables:{...E.prefilledVariables,remoteJid:E.remoteJid,pushName:E.pushName||E.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}):(R=`${E.url}/api/v1/sendMessage`,P={startParams:{publicId:E.typebot,prefilledVariables:{...E.prefilledVariables,remoteJid:E.remoteJid,pushName:E.pushName||E.prefilledVariables?.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number}}});let t=await G.post(R,P),U=null;return t?.data?.sessionId&&(U=await this.prismaRepository.integrationSession.create({data:{remoteJid:E.remoteJid,pushName:E.pushName||"",sessionId:`${O}-${t.data.sessionId}`,status:"opened",parameters:{...E.prefilledVariables,remoteJid:E.remoteJid,pushName:E.pushName||"",instanceName:e.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:e.number},awaitUser:!1,botId:E.botId,instanceId:e.id,type:"typebot"}})),{...t.data,session:U}}catch(r){this.logger.error(r);return}}async sendWAMessage(e,E,O,r,R,P,t){B(this.waMonitor.waInstances[e.name],E,O,R,P,t,C,this.prismaRepository).catch(n=>{console.error("Erro ao processar mensagens:",n)});function U(n,i){if(!n)return null;for(let c of n)if(c.lastBubbleBlockId===i)return c.wait?.secondsToWaitFor;return null}function C(n){let i="";if(n.text&&(i+=n.text),n.children&&n.type!=="a")for(let p of n.children)i+=C(p);n.type==="p"&&n.type!=="inline-variable"&&(i=i.trim()+`
`),n.type==="inline-variable"&&(i=i.trim()),n.type==="ol"&&(i=`
`+i.split(`
`).map((p,h)=>p?`${h+1}. ${p}`:"").join(`
`)),n.type==="li"&&(i=i.split(`
`).map(p=>p?`  ${p}`:"").join(`
`));let c="";n.bold&&(c+="*"),n.italic&&(c+="_"),n.underline&&(c+="~");let u=`${c}${i}${c.split("").reverse().join("")}`;return n.url&&(u=n.children[0]?.text?`[${u}]
(${n.url})`:`${n.url}`),u}async function B(n,i,c,u,p,h,H,M){for(let a of u){if(a.type==="text"){let s="";for(let T of a.content.richText){for(let N of T.children)s+=H(N);s+=`
`}if(s=s.replace(/\*\*/g,"").replace(/__/,"").replace(/~~/,"").replace(/\n$/,""),s=s.replace(/\n$/,""),s.includes("[list]")){let T={number:r.split("@")[0],title:"",description:"",buttonText:"",footerText:"",sections:[]},N=s.match(/\[title\]([\s\S]*?)(?=\[description\])/),I=s.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),A=s.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),m=s.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);N&&(T.title=N[1].trim()),I&&(T.description=I[1].trim()),A&&(T.buttonText=A[1].trim()),m&&(T.footerText=m[1].trim());let D=s.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(D){let L=D.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);L&&L.forEach(d=>{let _=d.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),S=d.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),l={title:_,rows:S?.map(V=>({title:V.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:V.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:V.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};T.sections.push(l)})}await n.listMessage(T)}else if(s.includes("[buttons]")){let T={number:r.split("@")[0],thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},N=s.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),I=s.match(/\[title\]([\s\S]*?)(?=\[description\])/),A=s.match(/\[description\]([\s\S]*?)(?=\[footer\])/),m=s.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);I&&(T.title=I[1].trim()),N&&(T.thumbnailUrl=N[1].trim()),A&&(T.description=A[1].trim()),m&&(T.footer=m[1].trim());let D={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[L,d]of Object.entries(D)){let _;for(;(_=d.exec(s))!==null;){let S=_[1].trim(),l={type:L};switch(L){case"pix":l.currency=S.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),l.name=S.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),l.keyType=S.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),l.key=S.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":l.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),l.id=S.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":l.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),l.copyCode=S.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":l.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),l.phoneNumber=S.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":l.displayText=S.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),l.url=S.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(l).length>1&&T.buttons.push(l)}}await n.buttonMessage(T)}else await n.textMessage({number:r.split("@")[0],delay:c?.delayMessage||1e3,text:s},!1);b("/message/sendText")}a.type==="image"&&(await n.mediaMessage({number:r.split("@")[0],delay:c?.delayMessage||1e3,mediatype:"image",media:a.content.url},null,!1),b("/message/sendMedia")),a.type==="video"&&(await n.mediaMessage({number:r.split("@")[0],delay:c?.delayMessage||1e3,mediatype:"video",media:a.content.url},null,!1),b("/message/sendMedia")),a.type==="audio"&&(await n.audioWhatsapp({number:r.split("@")[0],delay:c?.delayMessage||1e3,encoding:!0,audio:a.content.url},!1),b("/message/sendWhatsAppAudio"));let g=U(h,a.id);g&&await new Promise(s=>setTimeout(s,g*1e3))}if(console.log("input",p),p){if(p.type==="choice input"){let a="",g=p.items;for(let s of g)a+=`\u25B6\uFE0F ${s.content}
`;if(a=a.replace(/\n$/,""),a.includes("[list]")){let s={number:r.split("@")[0],title:"",description:"",buttonText:"",footerText:"",sections:[]},T=a.match(/\[title\]([\s\S]*?)(?=\[description\])/),N=a.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),I=a.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),A=a.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);T&&(s.title=T[1].trim()),N&&(s.description=N[1].trim()),I&&(s.buttonText=I[1].trim()),A&&(s.footerText=A[1].trim());let m=a.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(m){let D=m.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);D&&D.forEach(L=>{let d=L.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),_=L.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),S={title:d,rows:_?.map(l=>({title:l.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:l.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:l.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};s.sections.push(S)})}await n.listMessage(s)}else if(a.includes("[buttons]")){let s={number:r.split("@")[0],thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},T=a.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),N=a.match(/\[title\]([\s\S]*?)(?=\[description\])/),I=a.match(/\[description\]([\s\S]*?)(?=\[footer\])/),A=a.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);N&&(s.title=N[1].trim()),T&&(s.thumbnailUrl=T[1].trim()),I&&(s.description=I[1].trim()),A&&(s.footer=A[1].trim());let m={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[D,L]of Object.entries(m)){let d;for(;(d=L.exec(a))!==null;){let _=d[1].trim(),S={type:D};switch(D){case"pix":S.currency=_.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),S.name=_.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),S.keyType=_.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),S.key=_.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.id=_.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.copyCode=_.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.phoneNumber=_.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":S.displayText=_.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),S.url=_.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(S).length>1&&s.buttons.push(S)}}await n.buttonMessage(s)}else await n.textMessage({number:r.split("@")[0],delay:c?.delayMessage||1e3,text:a},!1);b("/message/sendText")}await M.integrationSession.update({where:{id:i.id},data:{awaitUser:!0}})}else c?.keepOpen?await M.integrationSession.update({where:{id:i.id},data:{status:"closed"}}):await M.integrationSession.deleteMany({where:{id:i.id}})}}async processTypebot(e,E,O,r,R,P,t,U,C,B,n,i,c,u,p,h){if(r&&t&&t>0){let s=Date.now(),T=new Date(r.updatedAt).getTime(),N=s-T;if(Math.floor(N/1e3/60)>t){u?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});let A=await this.createNewSession(e,{enabled:R?.enabled,url:P,typebot:U,expire:t,keywordFinish:C,delayMessage:B,unknownMessage:n,listeningFromMe:i,remoteJid:E,pushName:O.pushName,botId:R.id,prefilledVariables:h});if(A.session&&(r=A.session),A.messages.length===0){let m=Q(O.message);if(!m){n&&(this.waMonitor.waInstances[e.name].textMessage({number:E.split("@")[0],delay:B||1e3,text:n},!1),b("/message/sendText"));return}if(C&&m.toLowerCase()===C.toLowerCase()){u?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});return}try{let D=this.configService.get("TYPEBOT").API_VERSION,L,d;D==="latest"?(L=`${P}/api/v1/sessions/${A.sessionId}/continueChat`,d={message:m}):(L=`${P}/api/v1/sendMessage`,d={message:m,sessionId:A.sessionId});let _=await G.post(L,d);await this.sendWAMessage(e,r,{expire:t,keywordFinish:C,delayMessage:B,unknownMessage:n,listeningFromMe:i,stopBotFromMe:c,keepOpen:u},E,_.data.messages,_.data.input,_.data.clientSideActions)}catch(D){this.logger.error(D);return}}await this.sendWAMessage(e,r,{expire:t,keywordFinish:C,delayMessage:B,unknownMessage:n,listeningFromMe:i,stopBotFromMe:c,keepOpen:u},E,A.messages,A.input,A.clientSideActions);return}}if(r&&r.status!=="opened")return;if(!r){let s=await this.createNewSession(e,{enabled:R?.enabled,url:P,typebot:U,expire:t,keywordFinish:C,delayMessage:B,unknownMessage:n,listeningFromMe:i,remoteJid:E,pushName:O?.pushName,botId:R.id,prefilledVariables:h});if(s?.session&&(r=s.session),await this.sendWAMessage(e,r,{expire:t,keywordFinish:C,delayMessage:B,unknownMessage:n,listeningFromMe:i,stopBotFromMe:c,keepOpen:u},E,s?.messages,s?.input,s?.clientSideActions),s.messages.length===0){if(!p){n&&(this.waMonitor.waInstances[e.name].textMessage({number:E.split("@")[0],delay:B||1e3,text:n},!1),b("/message/sendText"));return}if(C&&p.toLowerCase()===C.toLowerCase()){u?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});return}let T;try{let N=this.configService.get("TYPEBOT").API_VERSION,I,A;N==="latest"?(I=`${P}/api/v1/sessions/${s.sessionId}/continueChat`,A={message:p}):(I=`${P}/api/v1/sendMessage`,A={message:p,sessionId:s.sessionId}),T=await G.post(I,A),await this.sendWAMessage(e,r,{expire:t,keywordFinish:C,delayMessage:B,unknownMessage:n,listeningFromMe:i,stopBotFromMe:c,keepOpen:u},E,T.data.messages,T.data.input,T.data.clientSideActions)}catch(N){this.logger.error(N);return}}return}if(await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"opened",awaitUser:!1}}),!p){n&&(this.waMonitor.waInstances[e.name].textMessage({number:E.split("@")[0],delay:B||1e3,text:n},!1),b("/message/sendText"));return}if(C&&p.toLowerCase()===C.toLowerCase()){u?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:R.id,remoteJid:E}});return}let H=this.configService.get("TYPEBOT").API_VERSION,M,a;H==="latest"?(M=`${P}/api/v1/sessions/${r.sessionId.split("-")[1]}/continueChat`,a={message:p}):(M=`${P}/api/v1/sendMessage`,a={message:p,sessionId:r.sessionId.split("-")[1]});let g=await G.post(M,a);await this.sendWAMessage(e,r,{expire:t,keywordFinish:C,delayMessage:B,unknownMessage:n,listeningFromMe:i,stopBotFromMe:c,keepOpen:u},E,g?.data?.messages,g?.data?.input,g?.data?.clientSideActions)}};export{F as TypebotService};
//# sourceMappingURL=typebot.service.mjs.map