var Ee=Object.create;var B=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var re=(a,e)=>{for(var E in e)B(a,E,{get:e[E],enumerable:!0})},h=(a,e,E,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of te(e))!ne.call(a,t)&&t!==E&&B(a,t,{get:()=>e[t],enumerable:!(o=se(e,t))||o.enumerable});return a};var O=(a,e,E)=>(E=a!=null?Ee(oe(a)):{},h(e||!a||!a.__esModule?B(E,"default",{value:a,enumerable:!0}):E,a)),Se=a=>h(B({},"__esModule",{value:!0}),a);var ie={};re(ie,{OpenaiService:()=>G});module.exports=Se(ie);var C={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};var w=O(require("dayjs")),x=O(require("fs"));var b=require("class-validator"),f=O(require("dotenv"));f.default.config();var v=class{constructor(){this.loadEnv()}get(e){return this.env[e]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY||"evolution",EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||""},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true"},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,b.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,b.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome",VERSION:process.env?.CONFIG_SESSION_PHONE_VERSION||null},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"}}}},M=new v;var ae=JSON.parse(x.default.readFileSync("./package.json","utf8")),V=a=>(0,w.default)(a).toDate().toString().replace(/\sGMT.+/,""),I=(s=>(s.LOG="\x1B[32m",s.INFO="\x1B[34m",s.WARN="\x1B[33m",s.ERROR="\x1B[31m",s.DEBUG="\x1B[36m",s.VERBOSE="\x1B[37m",s.DARK="\x1B[30m",s))(I||{});var W=(s=>(s.LOG="\x1B[32m%s\x1B[0m",s.DARK="\x1B[30m%s\x1B[0m",s.INFO="\x1B[34m%s\x1B[0m",s.WARN="\x1B[33m%s\x1B[0m",s.ERROR="\x1B[31m%s\x1B[0m",s.DEBUG="\x1B[36m%s\x1B[0m",s.VERBOSE="\x1B[37m%s\x1B[0m",s))(W||{}),K=(s=>(s.LOG="LOG",s.WARN="WARN",s.INFO="INFO",s.DARK="DARK",s.ERROR="ERROR",s.DEBUG="DEBUG",s.VERBOSE="VERBOSE",s))(K||{}),Y=(s=>(s.LOG="\x1B[42m",s.INFO="\x1B[44m",s.WARN="\x1B[43m",s.DARK="\x1B[40m",s.ERROR="\x1B[41m",s.DEBUG="\x1B[46m",s.VERBOSE="\x1B[47m",s))(Y||{}),d=class{constructor(e="Logger"){this.configService=M;this.instance=null;this.context=e}setContext(e){this.context=e}setInstance(e){this.instance=e}console(e,E){let o=[];this.configService.get("LOG").LEVEL.forEach(r=>o.push(K[r]));let t=typeof e;o.includes(E)&&(M.get("LOG").COLOR?(console.log("\x1B[1m"+W[E],"[Evolution API]","\x1B[1m"+I[E],this.instance?`[${this.instance}]`:"","\x1B[1m"+I[E],`v${ae.version}`,"\x1B[1m"+I[E],process.pid.toString(),"\x1B[0m","\x1B[1m"+I[E],"-","\x1B[1m\x1B[37m",`${V(Date.now())}  `,"\x1B[0m",I[E]+Y[E]+"\x1B[1m",`${E} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,I[E]+"\x1B[1m",`[${t}]\x1B[0m`,I[E],t!=="object"?e:"","\x1B[0m"),t==="object"&&console.log(e,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${V(Date.now())}  `,`${E} `,`[${this.context}]`,`[${t}]`,e))}log(e){this.console(e,"LOG")}info(e){this.console(e,"INFO")}warn(e){this.console(e,"WARN")}error(e){this.console(e,"ERROR")}verbose(e){this.console(e,"VERBOSE")}debug(e){this.console(e,"DEBUG")}dark(e){this.console(e,"DARK")}};var Q=O(require("axios")),F=O(require("fs")),Te=JSON.parse(F.default.readFileSync("./package.json","utf8")),u=async a=>{if(!(process.env.TELEMETRY_ENABLED===void 0||process.env.TELEMETRY_ENABLED==="true")||a==="/")return;let E={route:a,apiVersion:`${Te.version}`,timestamp:new Date},o=process.env.TELEMETRY_URL&&process.env.TELEMETRY_URL!==""?process.env.TELEMETRY_URL:"https://log.evolution-api.com/telemetry";Q.default.post(o,E).then(()=>{}).catch(()=>{})};var U=O(require("axios")),k=require("baileys"),X=O(require("form-data")),D=O(require("openai")),$=O(require("pino")),G=class{constructor(e,E,o){this.waMonitor=e;this.configService=E;this.prismaRepository=o;this.logger=new d("OpenaiService")}async sendMessageToBot(e,E,o,t){let n=E.systemMessages.map(i=>({role:"system",content:i})),S=E.assistantMessages.map(i=>({role:"assistant",content:i})),A=E.userMessages.map(i=>({role:"user",content:i})),c={role:"user",content:[{type:"text",text:t}]};if(this.isImageMessage(t)){let i=t.split("|"),N=i[1].split("?")[0];c.content=[{type:"text",text:i[2]||t},{type:"image_url",image_url:{url:N}}]}let _=[...n,...S,...A,c];e.integration===C.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(o),await e.client.sendPresenceUpdate("composing",o));let p=await this.client.chat.completions.create({model:E.model,messages:_,max_tokens:E.maxTokens});return e.integration===C.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",o),p.choices[0].message.content}async sendMessageToAssistant(e,E,o,t,r,n,s){let S={role:r?"assistant":"user",content:[{type:"text",text:n}]};if(this.isImageMessage(n)){let _=n.split("|"),p=_[1].split("?")[0];S.content=[{type:"text",text:_[2]||n},{type:"image_url",image_url:{url:p}}]}if(await this.client.beta.threads.messages.create(s,S),r){u("/message/sendText");return}let T=await this.client.beta.threads.runs.create(s,{assistant_id:E.assistantId});e.integration===C.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(o),await e.client.sendPresenceUpdate("composing",o));let A=await this.getAIResponse(s,T.id,E.functionUrl,o,t);return e.integration===C.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",o),A?.data[0].content[0].text.value}async sendMessageWhatsapp(e,E,o,t,r){let n=/(!?)\[(.*?)\]\((.*?)\)/g,s="",S=0,T,A=i=>{let N=i.split(".").pop()?.toLowerCase(),R=["jpg","jpeg","png","gif","bmp","webp"],l=["mp3","wav","aac","ogg"],P=["mp4","avi","mkv","mov"],g=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return R.includes(N||"")?"image":l.includes(N||"")?"audio":P.includes(N||"")?"video":g.includes(N||"")?"document":null};for(;(T=n.exec(r))!==null;){let[i,N,R,l]=T,P=A(l),g=r.slice(S,T.index);if(g&&(s+=g),P){let q=t.splitMessages??!1,j=t.timePerChar??0,z=1e3,Z=2e4;if(s.trim()){if(q){let H=s.trim().split(`

`);for(let m=0;m<H.length;m++){let y=H[m],J=Math.min(Math.max(y.length*j,z),Z);e.integration===C.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(o),await e.client.sendPresenceUpdate("composing",o)),await new Promise(ee=>{setTimeout(async()=>{await e.textMessage({number:o.split("@")[0],delay:t?.delayMessage||1e3,text:y},!1),ee()},J)}),e.integration===C.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",o)}}else await e.textMessage({number:o.split("@")[0],delay:t?.delayMessage||1e3,text:s.trim()},!1);s=""}P==="audio"?await e.audioWhatsapp({number:o.split("@")[0],delay:t?.delayMessage||1e3,audio:l,caption:R}):await e.mediaMessage({number:o.split("@")[0],delay:t?.delayMessage||1e3,mediatype:P,media:l,caption:R},null,!1)}else s+=`[${R}](${l})`;S=n.lastIndex}if(S<r.length){let i=r.slice(S);i.trim()&&(s+=i)}let c=t.splitMessages??!1,_=t.timePerChar??0,p=1e3,L=2e4;if(s.trim()){if(c){let i=s.trim().split(`

`);for(let N=0;N<i.length;N++){let R=i[N],l=Math.min(Math.max(R.length*_,p),L);e.integration===C.WHATSAPP_BAILEYS&&(await e.client.presenceSubscribe(o),await e.client.sendPresenceUpdate("composing",o)),await new Promise(P=>{setTimeout(async()=>{await e.textMessage({number:o.split("@")[0],delay:t?.delayMessage||1e3,text:R},!1),P()},l)}),e.integration===C.WHATSAPP_BAILEYS&&await e.client.sendPresenceUpdate("paused",o)}}else await e.textMessage({number:o.split("@")[0],delay:t?.delayMessage||1e3,text:s.trim()},!1);s=""}u("/message/sendText"),await this.prismaRepository.integrationSession.update({where:{id:E.id},data:{status:"opened",awaitUser:!0}})}async createAssistantNewSession(e,E){if(E.remoteJid==="status@broadcast")return;let o=await this.prismaRepository.openaiCreds.findFirst({where:{id:E.openaiCredsId}});if(!o)throw new Error("Openai Creds not found");try{this.client=new D.default({apiKey:o.apiKey});let t=(await this.client.beta.threads.create({})).id,r=null;return t&&(r=await this.prismaRepository.integrationSession.create({data:{remoteJid:E.remoteJid,pushName:E.pushName,sessionId:t,status:"opened",awaitUser:!1,botId:E.botId,instanceId:e.instanceId,type:"openai"}})),{session:r}}catch(t){this.logger.error(t);return}}async initAssistantNewSession(e,E,o,t,r,n,s,S){let T=await this.createAssistantNewSession(e,{remoteJid:E,pushName:o,openaiCredsId:r.openaiCredsId,botId:r.id});T.session&&(s=T.session);let A=await this.sendMessageToAssistant(e,r,E,o,t,S,s.sessionId);await this.sendMessageWhatsapp(e,s,E,n,A)}isJSON(e){try{return JSON.parse(e),!0}catch{return!1}}async getAIResponse(e,E,o,t,r){let n=await this.client.beta.threads.runs.retrieve(e,E),s;switch(n.status){case"requires_action":if(s=n?.required_action?.submit_tool_outputs?.tool_calls,s)for(let S of s){let T=S.id,A=S?.function?.name,c=this.isJSON(S?.function?.arguments)?JSON.parse(S?.function?.arguments):S?.function?.arguments,_=null;try{let{data:p}=await U.default.post(o,{name:A,arguments:{...c,remoteJid:t,pushName:r}});_=JSON.stringify(p).replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}catch(p){_=JSON.stringify(p).replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}await this.client.beta.threads.runs.submitToolOutputs(e,E,{tool_outputs:[{tool_call_id:T,output:_}]})}return this.getAIResponse(e,E,o,t,r);case"queued":return await new Promise(S=>setTimeout(S,1e3)),this.getAIResponse(e,E,o,t,r);case"in_progress":return await new Promise(S=>setTimeout(S,1e3)),this.getAIResponse(e,E,o,t,r);case"completed":return await this.client.beta.threads.messages.list(e,{run_id:E,limit:1})}}isImageMessage(e){return e.includes("imageMessage")}async processOpenaiAssistant(e,E,o,t,r,n,s,S){if(n&&n.status==="closed")return;if(n&&s.expire&&s.expire>0){let _=Date.now(),p=new Date(n.updatedAt).getTime(),L=_-p;if(Math.floor(L/1e3/60)>s.expire){s.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:r.id,remoteJid:E}}),await this.initAssistantNewSession(e,E,o,t,r,s,n,S);return}}if(!n){await this.initAssistantNewSession(e,E,o,t,r,s,n,S);return}if(n.status!=="paused"&&await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"opened",awaitUser:!1}}),!S){s.unknownMessage&&(this.waMonitor.waInstances[e.instanceName].textMessage({number:E.split("@")[0],delay:s.delayMessage||1e3,text:s.unknownMessage},!1),u("/message/sendText"));return}if(s.keywordFinish&&S.toLowerCase()===s.keywordFinish.toLowerCase()){s.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:n.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:r.id,remoteJid:E}});return}let T=await this.prismaRepository.openaiCreds.findFirst({where:{id:r.openaiCredsId}});if(!T)throw new Error("Openai Creds not found");this.client=new D.default({apiKey:T.apiKey});let A=n.sessionId,c=await this.sendMessageToAssistant(e,r,E,o,t,S,A);await this.sendMessageWhatsapp(e,n,E,s,c)}async createChatCompletionNewSession(e,E){if(E.remoteJid==="status@broadcast")return;let o=Math.floor(Math.random()*1e10).toString(),t=await this.prismaRepository.openaiCreds.findFirst({where:{id:E.openaiCredsId}});if(!t)throw new Error("Openai Creds not found");try{return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:E.remoteJid,pushName:E.pushName,sessionId:o,status:"opened",awaitUser:!1,botId:E.botId,instanceId:e.instanceId,type:"openai"}}),creds:t}}catch(r){this.logger.error(r);return}}async initChatCompletionNewSession(e,E,o,t,r,n,s){let S=await this.createChatCompletionNewSession(e,{remoteJid:E,pushName:o,openaiCredsId:t.openaiCredsId,botId:t.id});n=S.session;let T=S.creds;this.client=new D.default({apiKey:T.apiKey});let A=await this.sendMessageToBot(e,t,E,s);await this.sendMessageWhatsapp(e,n,E,r,A)}async processOpenaiChatCompletion(e,E,o,t,r,n,s){if(r&&r.status!=="opened")return;if(r&&n.expire&&n.expire>0){let A=Date.now(),c=new Date(r.updatedAt).getTime(),_=A-c;if(Math.floor(_/1e3/60)>n.expire){n.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:E}}),await this.initChatCompletionNewSession(e,E,o,t,n,r,s);return}}if(!r){await this.initChatCompletionNewSession(e,E,o,t,n,r,s);return}if(await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"opened",awaitUser:!1}}),!s){n.unknownMessage&&(this.waMonitor.waInstances[e.instanceName].textMessage({number:E.split("@")[0],delay:n.delayMessage||1e3,text:n.unknownMessage},!1),u("/message/sendText"));return}if(n.keywordFinish&&s.toLowerCase()===n.keywordFinish.toLowerCase()){n.keepOpen?await this.prismaRepository.integrationSession.update({where:{id:r.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:t.id,remoteJid:E}});return}let S=await this.prismaRepository.openaiCreds.findFirst({where:{id:t.openaiCredsId}});if(!S)throw new Error("Openai Creds not found");this.client=new D.default({apiKey:S.apiKey});let T=await this.sendMessageToBot(e,t,E,s);await this.sendMessageWhatsapp(e,r,E,n,T)}async speechToText(e,E,o){let t;E?.message?.mediaUrl?t=await U.default.get(E.message.mediaUrl,{responseType:"arraybuffer"}).then(S=>Buffer.from(S.data,"binary")):t=await(0,k.downloadMediaMessage)({key:E.key,message:E?.message},"buffer",{},{logger:(0,$.default)({level:"error"}),reuploadRequest:o});let r=this.configService.get("LANGUAGE").includes("pt")?"pt":this.configService.get("LANGUAGE"),n=new X.default;return n.append("file",t,"audio.ogg"),n.append("model","whisper-1"),n.append("language",r),(await U.default.post("https://api.openai.com/v1/audio/transcriptions",n,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${e.apiKey}`}}))?.data?.text}};0&&(module.exports={OpenaiService});
//# sourceMappingURL=openai.service.js.map